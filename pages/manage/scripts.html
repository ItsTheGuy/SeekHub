<!--
  SeekHub
  Copyright (C) 2021 ItsTheGuy

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script defer>
    const errorInformer = (data, message) => alert(`Something went wrong ðŸ˜®\n${message}: ${data.status ? data.status:"No request status"} - ${data.responseText ? data.responseText:"No response data"}`);

    const removeFormValuesFromURL = () => { let goodURLBuffer = ""; for (const char in window.location.href) { if (window.location.href[char] != "?") goodURLBuffer += window.location.href[char]; else window.location.href = goodURLBuffer; } };

    function auth() {
        event.preventDefault();
        const setupData = JSON.stringify($("#login").serializeArray());
        $.ajax({
          type: "POST",
          url: "/manage/secret",
          data: setupData,
          success: (data) => {
            document.getElementById("login").onsubmit = () => { return false };
            if (data["status"] === undefined || data["status"] === "failed" || data["status"] != "success") {  errorInformer(data, "Unexpected response"); return; }
            alert("Login sucessfull!")
          },
          error: (error) => { 
            if (error.status === 401) alert("Invalid credentials ðŸ˜¦");
            else errorInformer(error, "Request error");
          },
          dataType: "json",
          contentType : "application/json"
        });
    }

    window.onload = () => { removeFormValuesFromURL(); document.getElementById("login").onsubmit = () => { auth(); } };
    window.onbeforeunload = () => { removeFormValuesFromURL(); };
</script>