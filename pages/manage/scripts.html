<!--
  SeekHub
  Copyright (C) 2021 ItsTheGuy

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<script>
    const contexts = [
      ["login", () => { setButtonAction("login", auth, auth); }], 
      ["preferences", () => { setSubContext("preferencesPortfolio"); setButtonAction("", () => {}, () => {}); }],
    ];

    const subcontexts = [
      ["preferencesPortfolio", () => { setButtonAction("", () => {}, () => {}); }],
      ["preferencesSettings", () => { setButtonAction("", () => {}, () => {}); }]
    ];

    const errorInformer = (message) => alert(`${message}`);

    const setButtonAction = (context, funcButton, funcKey) => {
      const contextWithButtons = ["login"];
      for (const i in contextWithButtons) {
        if (contextWithButtons[i] === context) { document.getElementById(`${context}Button`).onclick = () => { funcButton() }; }
        else document.getElementById(`${contextWithButtons[i]}Button`).onclick = {};
      } document.onkeypress = (key) => { if (key.code === "Enter") funcKey(); }
    }

    const setContext = (context) => {
      for (const i in contexts) {
        if (contexts[i][0] === context) { contexts[i][1](); document.getElementById(context).style.display = "block"; }
        else document.getElementById(contexts[i][0]).style.display = "none";
      }
    }

    const setSubContext = (context) => {
      for (const i in subcontexts) {
        if (subcontexts[i][0] === context) { subcontexts[i][1](); document.getElementById(context).style.display = "block"; document.getElementById(`${context}Activator`).classList.add("active"); }
        else { document.getElementById(subcontexts[i][0]).style.display = "none"; document.getElementById(`${subcontexts[i][0]}Activator`).classList.remove("active"); }
      }
    }

    const request2Server = async (method, route, data) => {
      const request = fetch(new Request(route, {method: 'POST', headers: {'content-type': 'application/json'}, body: data}))
        .then((response) => { return response.clone().json() })
        .catch(() => { return });
      return request
    }

    const auth = async () => {
      const response = await request2Server("POST", "/manage/secret", (JSON.stringify([{name: "masterKey", value: (document.getElementById("masterKeyInput").value)}])))
      if (response === undefined) { errorInformer("Opps! Something went wrong ðŸ˜®"); return; };
      if (response["status"] === undefined || response["status"] === "failed") { errorInformer("Opps! Unexpected response ðŸ˜®"); return; }
      if (response["status"] === "invalid") { errorInformer("Opps! Invalid credentials ðŸ˜®"); return; }
      setButtonAction("login", () => {}, () => {});
      localStorage.setItem("sessionToken", response["token"]);
      authenticated = true;
      document.getElementById("masterKeyInput").value = "";
      setContext("preferences");
    }

    const logout = async () => {
      const sessionToken = localStorage.getItem("sessionToken");
      if (sessionToken === null) { authenticated = false; setContext("login"); return };
      try {
        const response = await request2Server("POST", "/manage/session/end", (JSON.stringify([{name: "token", value: sessionToken}])))
        if (response["status"] === undefined || response["status"] === "failed") { errorInformer("Opps! There was an error while trying to tell the server to invalidate the session (only local session will be invalidated) ðŸ˜®"); return; }
      } catch {
        errorInformer("Opps! Something went wrong ðŸ˜®");
      }
      localStorage.removeItem("sessionToken"); authenticated = false;
      setContext("login")
    }

    const checkSessionToken = async () => {
      const sessionToken = localStorage.getItem("sessionToken");
      if (sessionToken === null) return;
      const sessionValidation = await request2Server("POST", "/manage/session", (JSON.stringify([{name: "token", value: sessionToken}])))
      if (sessionValidation === undefined || sessionValidation["status"] === undefined || sessionValidation["status"] === "failed") { errorInformer("Opps! Something went wrong when trying to check the session code ðŸ˜®"); return; };
      if (sessionValidation["valid"] === true) { authenticated = true; return; }
      else { localStorage.removeItem("sessionToken"); }
    }

    window.onload = async () => {
      await checkSessionToken();
      if (!authenticated) setContext("login");
      else { setContext("preferences"); }
    };

    let authenticated = false;
</script>