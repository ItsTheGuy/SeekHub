<!--
  SeekHub
  Copyright (C) 2021 ItsTheGuy

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<script>
    const errorInformer = (message) => alert(`${message}`);
    
    const nextStage = (funcButton, funcKey) => {
      document.getElementById("submitButton").onclick = () => { funcButton() }
      document.onkeypress = (key) => { if (key.code === "Enter") funcKey(); }
    }

    const submitData = (data) => {
      const request = fetch(new Request('/manage/secret', {method: 'POST', headers: {'content-type': 'application/json'}, body: data}))
        .then((response) => { return response.clone().json() })
        .catch(() => { return });
      return request
    }

    const auth = async () => {
      const response = await submitData(JSON.stringify([{name: "masterKey", value: (document.getElementById("masterKeyInput").value)}]));
      if (response === undefined) { errorInformer("Opps! Something went wrong ðŸ˜®"); return; };
      if (response["status"] === undefined) { errorInformer("Opps! Unexpected response ðŸ˜®"); return; }
      if (response["status"] === "invalid") { errorInformer("Opps! Invalid credentials ðŸ˜®"); return; }
      if (response["status"] === "failed") { errorInformer("Opps! Unexpected response ðŸ˜®"); return; }
      window.onbeforeunload = () => { event.preventDefault(); };
      nextStage(() => {}, () => {});
      alert("Login was successful!")
      // localStorage.setItem("tempKey", response["token"]);
    }

    window.onload = () => { nextStage(auth, auth) };
</script>