<!--
  SeekHub
  Copyright (C) 2021 ItsTheGuy

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<script>
    const errorInformer = (message) => alert(`${message}`);

    const syncElementInput = (from, to) => {
      const fromElement = document.getElementById(from);
      const toElement = document.getElementById(to);
      if (toElement.value === "") toElement.value = fromElement.value;
    }

    const nextStage = (funcButton, funcKey) => {
      document.getElementById("submitButton").onclick = () => { funcButton() }
      document.onkeypress = (key) => { if (key.code === "Enter") funcKey(); }
    }

    const submitData = (data) => {
      const request = fetch(new Request('/setup', {method: 'POST', headers: {'content-type': 'application/json'}, body: data}))
        .then((response) => {
          if(!response.ok) return;
          else return response.clone().json();
        })
        .catch(() => { return });
        return request
    }
    
    const finishSetup = async (params) => {
      const setupData = JSON.stringify([
        {name: "name", value: (document.getElementById("nameInput").value)},
        {name: "title", value: (document.getElementById("titleInput").value)},
        {name: "navTitle", value: (document.getElementById("navTitleInput").value)},
        {name: "legalNotice", value: (document.getElementById("legalNoticeInput").value)}
      ]);
      const response = await submitData(setupData);
      if (response === undefined) { errorInformer("Opps! Something went wrong ðŸ˜®"); return; };
      window.onbeforeunload = () => { event.preventDefault(); };
      nextStage(() => {}, () => {});
      if (response["status"] === undefined || response["status"] === "failed" || response["status"] != "success" || response["id"] == undefined || response["masterKey"] == undefined) { errorInformer("Opps! Unexpected response ðŸ˜®"); return; }
      const formElements = ["title", "name", "navTitle", "legalNotice"]
      for (const i in formElements) {
        document.getElementById(`${formElements[i]}Container`).style.display = "none";
        document.getElementById(`${formElements[i]}Input`).readOnly = true;
      }
      document.getElementById('subtitle').innerHTML = "Now save your master key safely, don't share it with anyone!"
      const ask2Go = () => { if (confirm("Are you sure you want to continue? You won't be able to obtain the master key later!") == true) { window.onbeforeunload = () => { return }; location.reload(); } }; nextStage(ask2Go, ask2Go);
      document.getElementById("submitButton").setAttribute("value", "Finish!");
      document.getElementById("idContainer").style.display = "block";
      document.getElementById("masterKeyContainer").style.display = "block";
      document.getElementById("idInput").setAttribute("value", response["id"]);
      document.getElementById("masterKeyInput").setAttribute("value", response["masterKey"]);
    }

    window.onload = () => { 
      nextStage(() => {
        const formElements = ["title", "name", "navTitle", "legalNotice"]
          for (const i in formElements) {
            if (document.getElementById(`${formElements[i]}Input`).value === "") { alert("You haven't filled all the required fields ðŸ˜®"); return;}
          } finishSetup();
      }, () => finishSetup())
    };
</script>